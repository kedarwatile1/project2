pipeline {
    agent any

    environment {
        KUBECONFIG = "${WORKSPACE}/kubeconfig"
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'Source code checked out by Jenkins SCM'
            }
        }

        stage('Install kubectl (local)') {
            steps {
                sh '''
                if [ ! -f kubectl ]; then
                  echo "Installing kubectl locally in workspace"
                  curl -LO https://dl.k8s.io/release/v1.29.0/bin/linux/amd64/kubectl
                  chmod +x kubectl
                else
                  echo "kubectl already present"
                fi
                '''
            }
        }

        stage('Prepare kubeconfig') {
            steps {
                sh '''
                # Extract minikube server info from default config
                ./kubectl config view --raw > ${KUBECONFIG}
                echo "Kubeconfig copied into Jenkins workspace"
                '''
            }
        }

        stage('Set Minikube Context (AUTH FIX)') {
            steps {
                sh '''
                # Extract Minikube API IP
                MINIKUBE_SERVER=$(./kubectl config view -o jsonpath='{.clusters[?(@.name=="minikube")].cluster.server}')
                MINIKUBE_IP=$(echo $MINIKUBE_SERVER | sed 's|https://||' | sed 's|:.*||')

                echo "Using Minikube IP: $MINIKUBE_IP"

                # Override cluster to skip TLS auth (LOCAL DEV SAFE)
                ./kubectl config set-cluster minikube \
                  --server=https://$MINIKUBE_IP:8443 \
                  --insecure-skip-tls-verify=true \
                  --kubeconfig=${KUBECONFIG}

                ./kubectl config set-context minikube \
                  --cluster=minikube \
                  --user=minikube \
                  --kubeconfig=${KUBECONFIG}

                ./kubectl config use-context minikube --kubeconfig=${KUBECONFIG}
                '''
            }
        }

        stage('Verify Kubernetes Access') {
            steps {
                sh '''
                ./kubectl --kubeconfig=${KUBECONFIG} get nodes
                '''
            }
        }

        stage('Deploy to Minikube') {
            steps {
                sh '''
                ./kubectl --kubeconfig=${KUBECONFIG} apply -f deployment.yaml
                ./kubectl --kubeconfig=${KUBECONFIG} apply -f service.yaml
                '''
            }
        }

        stage('Verify Pods') {
            steps {
                sh '''
                ./kubectl --kubeconfig=${KUBECONFIG} get pods -o wide
                ./kubectl --kubeconfig=${KUBECONFIG} get svc
                '''
            }
        }
    }

    post {
        success {
            echo '✅ Deployment Successful'
        }
        failure {
            echo '❌ Deployment Failed'
        }
    }
}
